version: '3.8'

services:
  postgres:
    build:
      context: .
      dockerfile: Dockerfile
    image: postgres-pgbackrest:latest
    container_name: postgres-ba-primary
    hostname: postgres-ba-primary
    environment:
      # PostgreSQL Configuration
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
      
      # Mode Configuration
      PG_MODE: ${PG_MODE:-primary}
      
      # Backup Configuration
      RESTORE_FROM_BACKUP: ${RESTORE_FROM_BACKUP:-false}
      PGBACKREST_STANZA: ${PGBACKREST_STANZA:-main}
      PGBACKREST_PROCESS_MAX: ${PGBACKREST_PROCESS_MAX:-2}
      
      # S3 Configuration
      S3_BUCKET: ${S3_BUCKET}
      S3_ENDPOINT: ${S3_ENDPOINT:-s3.amazonaws.com}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_PATH: ${S3_PATH:-/pgbackrest}
      
      # Retention Configuration
      RETENTION_FULL: ${RETENTION_FULL:-3}
      RETENTION_DIFF: ${RETENTION_DIFF:-14}
      RETENTION_ARCHIVE: ${RETENTION_ARCHIVE:-2}
      
      # PostgreSQL Performance Configuration
      SHARED_BUFFERS: ${SHARED_BUFFERS:-1GB}
      EFFECTIVE_CACHE_SIZE: ${EFFECTIVE_CACHE_SIZE:-3GB}
      MAINTENANCE_WORK_MEM: ${MAINTENANCE_WORK_MEM:-256MB}
      WORK_MEM: ${WORK_MEM:-16MB}
      MAX_WAL_SENDERS: ${MAX_WAL_SENDERS:-10}
      MAX_REPLICATION_SLOTS: ${MAX_REPLICATION_SLOTS:-10}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_logs:/var/log/pgbackrest
      - postgres_ca:/var/lib/postgresql/ca
      - postgres_ssl:/var/lib/postgresql/ssl
    networks:
      - postgres_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Adminer for database management
  adminer:
    image: adminer:latest
    container_name: postgres-adminer
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    networks:
      - postgres_network
    restart: unless-stopped
    depends_on:
      - postgres

volumes:
  postgres_data:
    driver: local
  postgres_logs:
    driver: local
  postgres_ca:
    driver: local
  postgres_ssl:
    driver: local

networks:
  postgres_network:
    driver: bridge
