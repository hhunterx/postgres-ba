version: '3.8'

services:
  postgres-primary:
    build:
      context: .
      dockerfile: Dockerfile
    image: postgres-pgbackrest:latest
    container_name: postgres-cluster-primary
    hostname: postgres-cluster-primary
    environment:
      # PostgreSQL Configuration
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      
      # Mode Configuration - PRIMARY restaurado do S3
      PG_MODE: primary
      
      # Backup Configuration - Restaurar do S3
      RESTORE_FROM_BACKUP: ${RESTORE_FROM_BACKUP:-true}
      PGBACKREST_STANZA: ${PGBACKREST_STANZA:-main}
      PGBACKREST_PROCESS_MAX: ${PGBACKREST_PROCESS_MAX:-2}
      
      # S3 Configuration
      PGBACKREST_S3_BUCKET: ${PGBACKREST_S3_BUCKET}
      PGBACKREST_S3_ENDPOINT: ${PGBACKREST_S3_ENDPOINT:-s3.amazonaws.com}
      PGBACKREST_S3_REGION: ${PGBACKREST_S3_REGION:-us-east-1}
      PGBACKREST_S3_ACCESS_KEY: ${PGBACKREST_S3_ACCESS_KEY}
      PGBACKREST_S3_SECRET_KEY: ${PGBACKREST_S3_SECRET_KEY}
      PGBACKREST_S3_PATH: ${PGBACKREST_S3_PATH:-/pgbackrest}
      
      # Retention Configuration
      RETENTION_FULL: ${RETENTION_FULL:-3}
      RETENTION_DIFF: ${RETENTION_DIFF:-14}
      RETENTION_ARCHIVE: ${RETENTION_ARCHIVE:-2}
      
      # PostgreSQL Performance Configuration
      SHARED_BUFFERS: ${SHARED_BUFFERS:-1GB}
      EFFECTIVE_CACHE_SIZE: ${EFFECTIVE_CACHE_SIZE:-3GB}
      MAINTENANCE_WORK_MEM: ${MAINTENANCE_WORK_MEM:-256MB}
      WORK_MEM: ${WORK_MEM:-16MB}
      MAX_WAL_SENDERS: ${MAX_WAL_SENDERS:-10}
      MAX_REPLICATION_SLOTS: ${MAX_REPLICATION_SLOTS:-10}
    ports:
      - "${POSTGRES_PRIMARY_PORT:-5433}:5432"
    volumes:
      - postgres_cluster_primary_data:/var/lib/postgresql
      - postgres_cluster_primary_logs:/var/log/pgbackrest
      - postgres_cluster_ca:/var/lib/postgresql/ca
      - postgres_cluster_primary_ssl:/var/lib/postgresql/ssl
    networks:
      - postgres_cluster_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-replica:
    build:
      context: .
      dockerfile: Dockerfile
    image: postgres-pgbackrest:latest
    container_name: postgres-cluster-replica
    hostname: postgres-cluster-replica
    environment:
      # PostgreSQL Configuration
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      
      # Mode Configuration - REPLICA clonada do PRIMARY via pg_basebackup
      PG_MODE: replica
      PRIMARY_HOST: postgres-cluster-primary
      PRIMARY_PORT: 5432
      
      # Backup Configuration - A replica tamb√©m pode fazer backups (opcional)
      PGBACKREST_STANZA: ${PGBACKREST_STANZA:-main}
      PGBACKREST_PROCESS_MAX: ${PGBACKREST_PROCESS_MAX:-2}
      
      # S3 Configuration
      PGBACKREST_S3_BUCKET: ${PGBACKREST_S3_BUCKET}
      PGBACKREST_S3_ENDPOINT: ${PGBACKREST_S3_ENDPOINT:-s3.amazonaws.com}
      PGBACKREST_S3_REGION: ${PGBACKREST_S3_REGION:-us-east-1}
      PGBACKREST_S3_ACCESS_KEY: ${PGBACKREST_S3_ACCESS_KEY}
      PGBACKREST_S3_SECRET_KEY: ${PGBACKREST_S3_SECRET_KEY}
      PGBACKREST_S3_PATH: ${PGBACKREST_S3_PATH:-/pgbackrest}
      
      # Retention Configuration
      RETENTION_FULL: ${RETENTION_FULL:-3}
      RETENTION_DIFF: ${RETENTION_DIFF:-14}
      RETENTION_ARCHIVE: ${RETENTION_ARCHIVE:-2}
      
      # PostgreSQL Performance Configuration
      SHARED_BUFFERS: ${SHARED_BUFFERS:-1GB}
      EFFECTIVE_CACHE_SIZE: ${EFFECTIVE_CACHE_SIZE:-3GB}
      MAINTENANCE_WORK_MEM: ${MAINTENANCE_WORK_MEM:-256MB}
      WORK_MEM: ${WORK_MEM:-16MB}
      MAX_WAL_SENDERS: ${MAX_WAL_SENDERS:-10}
      MAX_REPLICATION_SLOTS: ${MAX_REPLICATION_SLOTS:-10}
    ports:
      - "${POSTGRES_REPLICA_PORT:-5434}:5432"
    volumes:
      - postgres_cluster_replica_data:/var/lib/postgresql
      - postgres_cluster_replica_logs:/var/log/pgbackrest
      - postgres_cluster_ca:/var/lib/postgresql/ca
      - postgres_cluster_replica_ssl:/var/lib/postgresql/ssl
    networks:
      - postgres_cluster_network
    restart: unless-stopped
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Adminer for database management
  adminer:
    image: adminer:latest
    container_name: postgres-cluster-adminer
    environment:
      ADMINER_DEFAULT_SERVER: postgres-cluster-primary
    ports:
      - "${ADMINER_PORT:-8081}:8080"
    networks:
      - postgres_cluster_network
    restart: unless-stopped
    depends_on:
      - postgres-primary
      - postgres-replica

volumes:
  postgres_cluster_ca:
    driver: local
  postgres_cluster_primary_data:
    driver: local
  postgres_cluster_primary_logs:
    driver: local
  postgres_cluster_primary_ssl:
    driver: local
  postgres_cluster_replica_data:
    driver: local
  postgres_cluster_replica_logs:
    driver: local
  postgres_cluster_replica_ssl:
    driver: local

networks:
  postgres_cluster_network:
    driver: bridge
